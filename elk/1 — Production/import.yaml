# zeropsPreprocessor=on
project:
  name: recipe-elk-production
  corePackage: SERIOUS

services:
  # Centerpiece of the ELK stack, Elasticsearch service.
  # Serves as a storage for the logs, traces, settings, etc.
  - hostname: elkstorage
    type: elasticsearch@8.16
    mode: HA
    priority: 10

  - hostname: kibana
    type: ubuntu@24.04
    buildFromGit: https://github.com/zerops-recipe-apps/elk-kibana-app
    enableSubdomainAccess: true
    envSecrets:
      NODE_OPTIONS_MAX_OLD_SPACE_SIZE_OVERRIDE: '4096'
    verticalAutoscaling:
      minRam: 0.75
    # Kibana needs extra settings and care to run in multiple instances,
    # limiting the amount of running instances to 1. See 'Scaling' section.
    maxContainers: 1

  # Feel free to remove this service, if you do not wish to use logging.
  - hostname: logstash
    type: ubuntu@24.04
    buildFromGit: https://github.com/zerops-recipe-apps/elk-logstash-app
    # Set higher heap memory for Logstash to handle more throughput.
    envSecrets:
      LOGSTASH_HEAP_MEMORY_OVERRIDE: 1g
    verticalAutoscaling:
      minRam: 1
      minFreeRamGB: 0.25

  # Feel free to remove this service, if you do not wish to use APM tracing.
  - hostname: apmserver
    type: ubuntu@24.04
    buildFromGit: https://github.com/zerops-recipe-apps/elk-apm-server-app
    envSecrets:
      SECRET_TOKEN: <@generateRandomString(<32>)>
